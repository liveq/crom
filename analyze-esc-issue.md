# ESC 키 한글 중복 입력 문제 분석

## 현재 상황
- 사용자가 "테스트"를 입력 후 ESC를 누르면 "테스트트"가 됨
- 마지막 글자가 중복되는 현상 발생
- 여러 차례 수정했으나 여전히 동일한 증상

## 문제 원인 분석

### 1. 한글 IME (Input Method Editor) 동작 원리
```
사용자 입력: ㅌ → ㅔ → ㅅ → ㅡ → 트(조합 중)
ESC 키 누름:
  - IME가 먼저 ESC를 받아 조합 중인 "트"를 확정
  - 그 다음 JavaScript 이벤트 핸들러가 실행
```

### 2. 이벤트 리스너 중첩 문제
현재 코드에서 ESC 키를 처리하는 곳:
1. **window 전역 이벤트 (capture 단계)** - useEffect에서 등록
2. **textarea onKeyDown** - 직접 props로 등록
3. **input onKeyDown** - 직접 props로 등록

→ 동일한 ESC 키가 여러 번 처리될 가능성

### 3. 이벤트 타이밍 문제
```
1. 한글 조합 중 ESC 입력
2. IME가 ESC를 가로채서 조합 완료 (트 확정)
3. compositionEnd 이벤트 발생 → isComposing = false
4. 그 다음 keydown 이벤트 발생
5. isComposing이 이미 false라서 정상 처리로 판단
```

### 4. Playwright 테스트 실패 원인
- Playwright가 한글 IME를 제대로 시뮬레이션하지 못함
- 실제 사용자 환경과 다른 이벤트 순서
- 권한 문제보다는 IME 시뮬레이션 한계

## 가능한 해결 방안

### 방안 1: 타이밍 기반 해결
- ESC 키 입력 후 짧은 딜레이를 두고 처리
- compositionEnd 직후 일정 시간 동안 ESC 무시

### 방안 2: 상태 기반 해결
- 마지막 입력 시간 추적
- ESC 누를 때 직전 입력과의 시간 차이 체크

### 방안 3: 우회 방법 (백스페이스)
- ESC 입력 시 자동으로 백스페이스 실행
- 단순하지만 부작용 가능성

### 방안 4: 브라우저 API 활용
- `InputEvent.isComposing` 속성 직접 체크
- 더 정확한 IME 상태 파악

## 권장 해결 방향

### 깔끔한 해결책: Debounce + State Management
1. compositionEnd 이벤트 후 100ms 동안 플래그 유지
2. ESC 키 처리 시 이 플래그 체크
3. 중복 이벤트 리스너 제거 (하나로 통합)

### 실용적 해결책: 텍스트 비교
1. ESC 키 누르기 직전 텍스트 저장
2. ESC 처리 후 텍스트 비교
3. 변경되었으면 원복

## 다음 단계
1. 브라우저 콘솔에서 이벤트 순서 직접 로깅
2. 가장 적합한 방안 선택
3. 최소한의 코드로 구현